import"@eox/chart";import"@eox/drawtools";import"@eox/jsonform";import{useSTAcStore as O}from"@/store/stac";import{s as F}from"./pinia.BvumBC0B.js";import{mapEl as G}from"@/store/states";import{useOnLayersUpdate as H}from"@/composables";import{p as l,aG as I,v as K,aP as M,h as z,C as j,c as h,o as f,e as y,G as J,N as W,k as S,aK as T,w as _,j as $,b as B,a as L}from"./framework.DpxBzJw_.js";import{eoxLayersKey as q}from"@/utils/keys";import{initProcess as g,useAutoExec as Q,onChartClick as N,handleProcesses as X}from"@/composables/EodashProcess";const Y={ref:"container",class:"process-container"},Z=[".schema"],ee=[".spec",".dataValues"],de={__name:"EodashProcess",setup(oe){const V=M(q),{selectedStac:p}=F(O()),r=l(null),w=l(null),n=l(!1),c=l(null),s=l(null),U=I("container"),d=l(!1),k=l(!1),m=l(!1),i=l([]),A=()=>{i.value.forEach(o=>{var u;if(!o)return;let e="",t="";if(typeof o=="string")e=o,t=e.includes("/")?e.split("/").pop():e,t=t.includes("?")?t.split("?")[0]:t;else{o=JSON.stringify(o);const v=new Blob([o],{type:"text"});e=URL.createObjectURL(v),t=((u=p.value)==null?void 0:u.id)+"_process_results.json"}const a=document.createElement("a");confirm(`Would you like to download ${t}?`)&&(a.href=e,a.download=t,a.click()),URL.revokeObjectURL(e),a.remove()})};K(async()=>{var o;((o=G.value)==null?void 0:o.layers.length)>1?await g({selectedStac:p,jsonformEl:s,jsonformSchema:c,chartSpec:r,isProcessed:n,processResults:i,loading:d,isPolling:m}):V.once(async()=>{await g({selectedStac:p,jsonformEl:s,jsonformSchema:c,chartSpec:r,isProcessed:n,loading:d,processResults:i,isPolling:m})})}),H(async(o,e)=>{o==="layers:updated"&&await g({selectedStac:p,jsonformEl:s,jsonformSchema:c,chartSpec:r,isProcessed:n,processResults:i,loading:d,isPolling:m})});const E=async()=>{var u,v,x;const e=(P=>{var C,R;for(const b in P.properties)if((R=(C=P.properties[b])==null?void 0:C.options)!=null&&R.drawtools)return b})(c.value);if(e&&Array.isArray((u=s.value)==null?void 0:u.value[e])&&!((v=s.value)!=null&&v.value[e].length)){n.value=!1,r.value=null;return}const a=(x=s.value)==null?void 0:x.editor.validate();if(a!=null&&a.length){console.warn("[eodash] Form validation failed",a);return}i.value=[],await X({jsonformEl:s,jsonformSchema:c,chartSpec:r,chartData:w,loading:d,selectedStac:p,isProcessed:n,isPolling:m,processResults:i}),n.value=!0};Q(k,s,c,E);const D=z(()=>{var e,t,a;const o={};return(e=r.value)!=null&&e.height||(o.height=Math.max((((t=U.value)==null?void 0:t.offsetHeight)??0)-(((a=s.value)==null?void 0:a.offsetHeight)??0),200)+"px"),o});return(o,e)=>{const t=j("v-btn"),a=j("v-container");return f(),h("div",Y,[c.value?(f(),h("eox-jsonform",{key:0,ref_key:"jsonformEl",ref:s,".schema":c.value},null,40,Z)):y("",!0),n.value&&r.value?(f(),h("eox-chart",{key:1,class:"chart",".spec":T(r.value),".dataValues":T(w.value),"onClick:item":e[0]||(e[0]=(...u)=>S(N)&&S(N)(...u)),style:W(D.value)},null,44,ee)):y("",!0),J(a,null,{default:_(()=>[$("span",null,[k.value?y("",!0):(f(),B(t,{key:0,loading:d.value,style:{float:"right","margin-right":"20px"},onClick:E,color:"primary"},{default:_(()=>e[1]||(e[1]=[L(" Execute ")])),_:1},8,["loading"])),i.value.length&&n.value?(f(),B(t,{key:1,color:"primary",onClick:A},{default:_(()=>e[2]||(e[2]=[L(" Download ")])),_:1})):y("",!0)])]),_:1})],512)}}};export{de as default};
