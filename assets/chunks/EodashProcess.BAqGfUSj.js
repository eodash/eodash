import"@eox/chart";import"@eox/drawtools";import"@eox/jsonform";import{useSTAcStore as P}from"@/store/stac";import{s as V}from"./pinia.CQFdOwJa.js";import{mapEl as N}from"@/store/states";import{useOnLayersUpdate as U}from"@/composables";import{ax as O,p as i,v as T,B as j,o as _,c as w,e as g,at as R,G as A,w as x,j as D,b as S,a as B}from"./framework.BDJVpM2J.js";import{eoxLayersKey as F}from"@/utils/keys";import{initProcess as E,useAutoExec as M,handleProcesses as z}from"@/composables/EodashProcess";const h=new Map;function G(m){const y=O();function u(t){var e;const l=h.get(m)||new Set;l.add(t),h.set(m,l);const c=()=>p(t);return(e=y==null?void 0:y.cleanups)==null||e.push(c),c}function f(t){function e(...l){p(e),t(...l)}return u(e)}function p(t){const e=h.get(m);e&&(e.delete(t),e.size||a())}function a(){h.delete(m)}function r(t,e){var l;(l=h.get(m))==null||l.forEach(c=>c(t,e))}return{on:u,once:f,off:p,emit:r,reset:a}}const J={class:"process-container"},K=[".schema"],W=[".spec",".dataValues"],oe={__name:"EodashProcess",setup(m){const y=G(F),{selectedStac:u}=V(P()),f=i(null),p=i(null),a=i(!1),r=i(null),t=i(null),e=i(!1),l=i(!1),c=i(!1),d=i([]),C=()=>{d.value.forEach(o=>{var b;if(!o)return;let n="",s="";if(typeof o=="string")n=o,s=n.includes("/")?n.split("/").pop():n,s=s.includes("?")?s.split("?")[0]:s;else{o=JSON.stringify(o);const L=new Blob([o],{type:"text"});n=URL.createObjectURL(L),s=((b=u.value)==null?void 0:b.id)+"_process_results.json"}const v=document.createElement("a");confirm(`Would you like to download ${s}?`)&&(v.href=n,v.download=s,v.click()),URL.revokeObjectURL(n),v.remove()})};T(async()=>{var o;((o=N.value)==null?void 0:o.layers.length)<=1?y.once(async()=>{await E({selectedStac:u,jsonformEl:t,jsonformSchema:r,chartSpec:f,isProcessed:a,loading:e,processResults:d,isPolling:c})}):await E({selectedStac:u,jsonformEl:t,jsonformSchema:r,chartSpec:f,isProcessed:a,processResults:d,loading:e,isPolling:c})}),U(async()=>await E({selectedStac:u,jsonformEl:t,jsonformSchema:r,chartSpec:f,isProcessed:a,processResults:d,loading:e,isPolling:c}));const k=async()=>{var n;const o=(n=t.value)==null?void 0:n.editor.validate();if(o!=null&&o.length){console.warn("[eodash] Form validation failed",o);return}d.value=[],await z({jsonformEl:t,jsonformSchema:r,chartSpec:f,chartData:p,loading:e,selectedStac:u,isProcessed:a,isPolling:c,processResults:d}),a.value=!0};return M(l,t,r,k),(o,n)=>{const s=j("v-btn"),v=j("v-container");return _(),w("div",J,[r.value?(_(),w("eox-jsonform",{key:0,ref_key:"jsonformEl",ref:t,".schema":r.value},null,40,K)):g("",!0),a.value&&f.value?(_(),w("eox-chart",{key:1,class:"chart",".spec":R(f.value),".dataValues":R(p.value)},null,40,W)):g("",!0),A(v,null,{default:x(()=>[D("span",null,[l.value?g("",!0):(_(),S(s,{key:0,loading:e.value,style:{float:"right","margin-right":"20px"},onClick:k,color:"primary"},{default:x(()=>n[0]||(n[0]=[B(" Execute ")])),_:1},8,["loading"])),d.value.length&&a.value?(_(),S(s,{key:1,color:"primary",onClick:C},{default:x(()=>n[1]||(n[1]=[B(" Download ")])),_:1})):g("",!0)])]),_:1})])}}};export{oe as default};
