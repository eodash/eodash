import"@eox/chart";import"@eox/drawtools";import"@eox/jsonform";import{useSTAcStore as P}from"@/store/stac";import{s as V}from"./pinia.VG4EcYuH.js";import{mapEl as C}from"@/store/states";import{useOnLayersUpdate as O}from"@/composables";import{p as s,aG as U,v as T,h as A,B as x,o as m,c as v,e as p,aK as E,N as D,G as F,w as h,aO as G,j as H,b as R,a as b}from"./framework.DmpuTMbk.js";import{eoxLayersKey as K}from"@/utils/keys";import{initProcess as y,useAutoExec as M,handleProcesses as z}from"@/composables/EodashProcess";const J={ref:"container",class:"process-container"},W=[".schema"],$=[".spec",".dataValues"],ne={__name:"EodashProcess",setup(q){const j=G(K),{selectedStac:u}=V(P()),l=s(null),_=s(null),r=s(!1),c=s(null),n=s(null),S=U("container"),d=s(!1),g=s(!1),f=s(!1),i=s([]),B=()=>{i.value.forEach(e=>{var w;if(!e)return;let o="",t="";if(typeof e=="string")o=e,t=o.includes("/")?o.split("/").pop():o,t=t.includes("?")?t.split("?")[0]:t;else{e=JSON.stringify(e);const N=new Blob([e],{type:"text"});o=URL.createObjectURL(N),t=((w=u.value)==null?void 0:w.id)+"_process_results.json"}const a=document.createElement("a");confirm(`Would you like to download ${t}?`)&&(a.href=o,a.download=t,a.click()),URL.revokeObjectURL(o),a.remove()})};T(async()=>{var e;((e=C.value)==null?void 0:e.layers.length)<=1?j.once(async()=>{await y({selectedStac:u,jsonformEl:n,jsonformSchema:c,chartSpec:l,isProcessed:r,loading:d,processResults:i,isPolling:f})}):await y({selectedStac:u,jsonformEl:n,jsonformSchema:c,chartSpec:l,isProcessed:r,processResults:i,loading:d,isPolling:f})}),O(async(e,o)=>{e==="layers:updated"&&await y({selectedStac:u,jsonformEl:n,jsonformSchema:c,chartSpec:l,isProcessed:r,processResults:i,loading:d,isPolling:f})});const k=async()=>{var o;const e=(o=n.value)==null?void 0:o.editor.validate();if(e!=null&&e.length){console.warn("[eodash] Form validation failed",e);return}i.value=[],await z({jsonformEl:n,jsonformSchema:c,chartSpec:l,chartData:_,loading:d,selectedStac:u,isProcessed:r,isPolling:f,processResults:i}),r.value=!0};M(g,n,c,k);const L=A(()=>{var o,t,a;const e={};return(o=l.value)!=null&&o.height||(e.height=Math.max((((t=S.value)==null?void 0:t.offsetHeight)??0)-(((a=n.value)==null?void 0:a.offsetHeight)??0),200)+"px"),e});return(e,o)=>{const t=x("v-btn"),a=x("v-container");return m(),v("div",J,[c.value?(m(),v("eox-jsonform",{key:0,ref_key:"jsonformEl",ref:n,".schema":c.value},null,40,W)):p("",!0),r.value&&l.value?(m(),v("eox-chart",{key:1,class:"chart",".spec":E(l.value),".dataValues":E(_.value),style:D(L.value)},null,44,$)):p("",!0),F(a,null,{default:h(()=>[H("span",null,[g.value?p("",!0):(m(),R(t,{key:0,loading:d.value,style:{float:"right","margin-right":"20px"},onClick:k,color:"primary"},{default:h(()=>o[0]||(o[0]=[b(" Execute ")])),_:1},8,["loading"])),i.value.length&&r.value?(m(),R(t,{key:1,color:"primary",onClick:B},{default:h(()=>o[1]||(o[1]=[b(" Download ")])),_:1})):p("",!0)])]),_:1})],512)}}};export{ne as default};
